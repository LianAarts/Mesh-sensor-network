<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mesh network node: Mesh Network of Environmental Sensors</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Mesh network node
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Mesh Network of Environmental Sensors </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md__Users_lian_Documents_PlatformIO_Projects_rootselection_readme"></a> The purpose of this project is to deploy classrooms with environmental sensors that measure metrics like temperature and humidity. Because of the large area that has to be covered, it is impossible to set up a conventional solution. The Wifi infrastructure of the school cannot be used for security reasons.</p>
<p >The solution to these problems is the deployment of a mesh network. The nodes in a mesh network don't only act as clients but also as repeaters. Every node will expand the network.</p>
<p ><a href="https://meshnetwork.sinners.be">Description of the code.</a></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Centralized architecture   </th><th class="markdownTableHeadCenter">Mesh architecture    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter"><img src="conventional_setup.png" alt="" class="inline" title="conventional setup"/>     </td><td class="markdownTableBodyCenter"><img src="mesh_setup.png" alt="" class="inline" title="mesh setup"/>     </td></tr>
</table>
<p >The painless mesh library enables us to set up this network without needing to worry about how the network is structured or managed. We only need to worry about our root node. The use of a root node is highly recommended and will improve the stability of the network.</p>
<p >The root node can be used as a bridge to another network. This functionality is important so we can send our data to Home Assistant. We will use the REST API of Home Assistant to transfer the sensor data. Our root has to be selected based on the connection strength to the access point.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
File layout</h1>
<ul>
<li>main: main loop</li>
<li>rd_22_280sensor: Functions for the BME280.</li>
<li>rd_22_680sensor: Functions for the BME680.</li>
<li>rd_22_api: Setup and callback for the API on the root node.</li>
<li>rd_22_mesh: Mesh setup, callbacks and messaging.</li>
<li>rd_22_node_class: Functions for the node class.</li>
<li>rd_22_setup_portal: Reading and writing EEPROM. Captive configuration portal.</li>
<li>rd_22_wifi: Measuring RSSI, connecting to the server, POST request and JSON deserialization.</li>
</ul>
<h1><a class="anchor" id="autotoc_md2"></a>
Necessary steps</h1>
<ol type="1">
<li>Configuration of identifier</li>
<li>Measure RSSI to the access point</li>
<li>Setup mesh</li>
<li>Select a root</li>
<li>Connect to access point &amp; setup API</li>
<li>Send measurements</li>
</ol>
<h2><a class="anchor" id="autotoc_md3"></a>
Extra functionality:</h2>
<ol type="1">
<li>Reset the name with a button</li>
</ol>
<h2><a class="anchor" id="autotoc_md4"></a>
1. Configuration of the identifier</h2>
<p >Every node needs its unique identifier. It is important that this can be configured by the users of the sensors. To be able to set an identifier we set up a small access point and webserver on the ESP. When you connect to this access point you can enter a name in the captive portal. The configuration will be saved in the EEPROM so it is not lost when there is a loss of power.</p>
<p >Steps we execute:</p><ul>
<li>Read spiffs, if we have saved data we don't need the webserver</li>
<li>setup the webserver and the DNS handler</li>
<li>Wait for data submit</li>
<li>Write the data to EEPROM</li>
<li>End the webserver</li>
</ul>
<p ><img src="md_resources/diagram_configuration.jpeg" alt="configuration diagram" width="400" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md5"></a>
Dependencies:</h3>
<p ><a href="https://github.com/me-no-dev/ESPAsyncWebServer">ESPAsyncWebServer</a>: We use this to be able to set up the webserver.</p>
<p ><a href="https://github.com/espressif/arduino-esp32/tree/master/libraries/DNSServer">DNSServer</a>: Used to make a captive portal. When you connect to the access point a webpage will pop up.</p>
<p ><a href="https://github.com/espressif/arduino-esp32/tree/master/libraries/SPIFFS">SPIFFS</a>: Used for reading and writing data in EEPROM.</p>
<h2><a class="anchor" id="autotoc_md6"></a>
2. Measure RSSI:</h2>
<p >The Received Signal Strength Index (RSSI) is used to determine the best root node. The RSSI is the measurement of how strong the signal of a router or access point is to a device. The RSSI is a value between -100 and 0. An RSSI closer to 0 means a better connection.</p>
<p >Steps we execute:</p><ul>
<li>Scan all networks</li>
<li>Find the network with the SSID we want to connect to</li>
<li>Measure the RSSI (when we have no connection we set the RSSI to -100)</li>
</ul>
<p ><img src="md_resources/diagram_measure_RSSI.jpeg" alt="RSSI diagram" width="400" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md7"></a>
Dependencies:</h3>
<p ><a href="https://github.com/espressif/arduino-esp32/tree/master/libraries/WiFi">WiFi</a>: To scan for networks and retrieve the RSSI.</p>
<h2><a class="anchor" id="autotoc_md8"></a>
3. Setup the mesh:</h2>
<p >The mesh network uses its SSID and password. Every node that uses the same credentials will join the same mesh network. The use of delay() should be avoided. Using delay() will cause the mesh to fall apart.</p>
<p >The mesh.update() function should be executed as much as possible. When a message from the mesh network is received a callback will be executed.</p>
<h3><a class="anchor" id="autotoc_md9"></a>
Dependencies:</h3>
<p ><a href="https://gitlab.com/painlessMesh/painlessMesh">painlessMesh</a>: Mesh library.</p>
<h2><a class="anchor" id="autotoc_md10"></a>
4. Select a root</h2>
<p >When a mesh network is set up, a root has to be selected that will act as a bridge. All the nodes in the network will start broadcasting their RSSI values to each other. When a node receives a message with a better RSSI than its RSSI it will stop broadcasting its RSSI. Eventually, there will be only one node that is still broadcasting its RSSI. This node will be selected to be the root.</p>
<p >Steps we execute:</p><ul>
<li>Broadcast RSSI.</li>
<li>When other nodes have a better RSSI stop broadcasting.</li>
<li>When the node does not receive any more RSSI data declare himself as root.</li>
</ul>
<p ><img src="md_resources/diagram_root_selection.jpeg" alt="root selection diagram" width="400" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md11"></a>
Dependencies:</h3>
<p ><a href="https://gitlab.com/painlessMesh/painlessMesh">painlessMesh</a>: Mesh library.</p>
<h2><a class="anchor" id="autotoc_md12"></a>
5. Connect to access point</h2>
<p >Only if the node is root!</p>
<p >When a node is declared as root it will connect to the access point. A REST API will also be set up so Home Assistant can send messages to the mesh network.</p>
<p >Connecting to the access point can be tricky because the mesh network is still running. Sometimes the connection fails, the node will be reset when this happens.</p>
<p >The root will start broadcasting a message telling all the nodes to send measurements to his address. This is also a message telling the nodes that the root is still alive.</p>
<h3><a class="anchor" id="autotoc_md13"></a>
Dependencies:</h3>
<p ><a href="https://github.com/espressif/arduino-esp32/tree/master/libraries/WiFi">WiFi</a>: For the connection to the access point.</p>
<p ><a href="https://github.com/espressif/arduino-esp32/tree/master/libraries/WebServer">WebServer</a>: Used for the REST API server.</p>
<p ><a href="https://arduinojson.org">ArduinoJson</a>: To deserialize the JSON message of the REST API.</p>
<h2><a class="anchor" id="autotoc_md14"></a>
6. Send measurements</h2>
<p >All the nodes will read the sensor data and start sending their messages to the root node. The messages are specifically formatted to ease deserialization. When the root receives these messages they will be posted to Home Assistant.</p>
<p >The JSON model we use is based on SenML which is designed for sending sensor data. This structure allows us to expand this Json without needing to change the deserialization function. Every part of the JSON is used for the POST request to Home Assistant.</p>
<ul>
<li>bn: Base name or sensor name (sensor1)</li>
<li>n: Measurement name (temperature)</li>
<li>u: Unit of Measurement (°C)</li>
<li>v: Value (21.8) <div class="fragment"><div class="line">[</div>
<div class="line"> {&quot;bn&quot;: &quot;sensor1&quot;, &quot;n&quot;: &quot;temperature&quot;, &quot;u&quot;: &quot;°C&quot;, &quot;v&quot;: &quot;25.6&quot;},</div>
<div class="line"> {&quot;n&quot;: &quot;humidity&quot;, &quot;u&quot;: &quot;%&quot;, &quot;v&quot;:&quot;69.42&quot;},</div>
<div class="line"> {&quot;n&quot;: &quot;pressure&quot;, &quot;u&quot;: &quot;Hpa&quot;, &quot;v&quot;:&quot;1016&quot;}, </div>
<div class="line"> {&quot;n&quot;: &quot;chipID&quot;, &quot;u&quot;: &quot;ID&quot;, &quot;v&quot;:&quot;629348013&quot;}, </div>
<div class="line"> {&quot;n&quot;: &quot;rootIP&quot;, &quot;u&quot;: &quot;&quot;, &quot;v&quot;:&quot;192.168.99.43&quot;}</div>
<div class="line">]</div>
</div><!-- fragment --></li>
</ul>
<p >If the root loses its connection to Home Assistant it will stop broadcasting. In this case, all the nodes that stop receiving these messages will start selecting a new root.</p>
<h3><a class="anchor" id="autotoc_md15"></a>
Dependencies:</h3>
<p ><a href="https://github.com/Zanduino/BME680">Zanshin_BME680</a>: Read the sensor data if the BME680 is used.</p>
<p ><a href="https://github.com/adafruit/Adafruit_BME280_Library">Adafruit_BME280</a>: Read the sensor data if the BME6280 is used.</p>
<p ><a href="https://arduinojson.org">ArduinoJson</a>: To deserialize the JSON message of the mesh network.</p>
<p ><a href="https://github.com/espressif/arduino-esp32/tree/master/libraries/HTTPClient">HTTPClient</a>: Used for the POST request to Home Assistant. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
